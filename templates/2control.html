<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Toy Car Controller</title>
<style>
  body { font-family: Arial; text-align: center; margin-top: 40px; }
  h2 { margin-bottom: 20px; }
  .controller {
    display: inline-grid;
    grid-template-columns: 80px 80px 80px;
    gap: 10px;
  }
  button {
    width: 80px; height: 80px;
    font-size: 20px;
    cursor: pointer;
  }
  #status {
    margin-top: 20px;
    text-align: left;
    display: inline-grid;
    width: 240px;
    font-size: 16px;
    color: #333;
  }
</style>
</head>
<body>
  <h2>Toy Car Controller</h2>
  <div class="controller">
    <div></div>
    <button id="up">‚Üë</button>
    <div></div>

    <button id="left">‚Üê</button>
    <button id="down">‚Üì</button>
    <button id="right">‚Üí</button>
    <label for="gear">Gear:</label>
    <input type="range" id="gear" name="gear" min="0" max="100" value="0" oninput= "outpu>

    <div></div>
    <label for="gear">Gear level:</label>
    <output id="output">0</output>
    <div></div>


    <div id="status">Speed: 0 | Turn: 0 </div>
  </div>
  <script>


    let sessionToken = null;

    let speed = 0;
    let turn = 0;
    let gear = 0;
// Heartbeat tracking
    let lastHeartbeat = Date.now();      // <--- HERE
    let connectionAlive = true;

    const HEARTBEAT_INTERVAL = 1000;     // send every 1 second
    const HEARTBEAT_TIMEOUT = 2500;      // if no reply for 2.5 sec -> timeout

    const gearSlider = document.getElementById('gear');
    const output = document.getElementById('output');

    const updateStatus = () => {
      document.getElementById("status").innerText =
        `Speed: ${speed} | Turn: ${turn} | Gear: ${gear}`;
    };

// -----------------------------
// Send values to Flask backend
// -----------------------------
//    const sendControl = async () => {
//      await fetch('/control', {
//        method: 'POST',
//        headers: { 'Content-Type': 'application/json' },
//        body: JSON.stringify({ speed, turn, gear, token: sessionToken })
//      });
//    };

// -----------------------------
// Keyboard
// -----------------------------
    const handleKey = (key, isDown = true) => {
      if (!isDown) return;

      switch (key) {
        case 'ArrowUp':
          speed = Math.min(speed + 1, 100);
          break;
        case 'ArrowDown':
          speed = Math.max(speed - 1, -100);
          break;

        case ' ':
          speed = 0;
          turn = 0;
          break;
      }
      updateStatus();
      sendControl();
    };

    document.addEventListener('keydown', e => handleKey(e.key));

    // Button controls
    document.getElementById('up').onclick = () => handleKey('ArrowUp');
    document.getElementById('down').onclick = () => handleKey('ArrowDown');

// -----------------------------
// HOLD BUTTON ‚Üí change steering
// RELEASE BUTTON ‚Üí reset steering
// -----------------------------
    let steeringInterval = null;

    function startSteer(direction) {
  // change turn every 80 ms
      steeringInterval = setInterval(() => {
        turn += direction;         // direction = -1 (left) or +1 (right)
        turn = Math.max(Math.min(turn, 45), -45); // clamp
        updateStatus();
        sendControl();
      }, 80);
    }

    function stopSteer() {
      clearInterval(steeringInterval);
      steeringInterval = null;

  // reset steering
      turn = 0;
      updateStatus();
      sendControl();
    }

//function closeSession()
    function closeSession() {
      sessionToken = null;
      speed = 0;
      turn = 0;
      gear = 0;
      document.getElementById("gear").value = 0;
      updateStatus();
      console.log("‚ö† Session closed due to timeout");
      }
//function reset all
    function resetAll() {
      speed = 0;
      turn = 0;
      gear = 0;
      if (gearSlider) gearSlider.value = 0;
      if (output) output.value = 0;

      updateStatus();
      sendControl();   // send 0 values to backend
      console.warn("Controller disconnected ‚Äî values reset");
    }
    //heartbeat
    async function heartbeat() {
      try {
        const res = await fetch("/heartbeat");
        if (res.ok) {
          //heartbeat received   
          lastHartbeat = Date.now();
          if (!connectionAlive) {
            connnectionAlive = true;
            console.log("üü¢ Reconnected to server");
            await createNewSession(); //open a new session
          }
        }
      } catch (err) {
        resetAll();
      }
    }
    //when heartbeat works again
    async function createNewSession() {
      try {
        let res = await fetch("/session");
        let data = await res.json();
        sessionToken = data.token;
        console.log("üü¢ New session opened:", sessionToken);
        }
    
// If timed out ‚Üí close session
    setInterval(() => {
      if (Date.now() - lastHeartbeat > HEARTBEAT_TIMEOUT) {
        if (connectionAlive) {
          console.log("üî¥ Connection lost ‚Äî timeout reached");
          connectionAlive = false;
          closeSession();      // <-- session reset
        }
      } 
    }, 500);
//send heartbeat repeatedly
    setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
//safe send control
    async function safeSendControl() {
      if (!connectionAlive || !sessionToken] return;

      await fetch("/control", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          speed,
          turn,
          gear,
          token: sessionToken
        })
      })
    }
      
// If heartbeat recovers ‚Üí open new session
    if (!connectionAlive && r.ok) {
      connectionAlive = true;
      createNewSession();      // <-- new session
    }
    setInterval(heartbeat, 1000); //set heartbeat 1s   

// LEFT button
    const leftBtn = document.getElementById('left');
    leftBtn.addEventListener('mousedown', () => startSteer(-1));
    leftBtn.addEventListener('mouseup', stopSteer);
    leftBtn.addEventListener('mouseleave', stopSteer);

// RIGHT button
    const rightBtn = document.getElementById('right');
    rightBtn.addEventListener('mousedown', () => startSteer(1));
    rightBtn.addEventListener('mouseup', stopSteer);
    rightBtn.addEventListener('mouseleave', stopSteer);

// mobile
    leftBtn.addEventListener('touchstart', () => startSteer(-1));
    leftBtn.addEventListener('touchend', stopSteer);

    rightBtn.addEventListener('touchstart', () => startSteer(1));
    rightBtn.addEventListener('touchend', stopSteer);

// -----------------------------
// Slider
// -----------------------------
    gearSlider.addEventListener('input', () => {
      gear = parseInt(gearSlider.value, 10);
      output.value = gear;
      updateStatus();
      sendControl();
    });

  </script>
