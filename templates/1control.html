<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Toy Car Controller</title>
<style>
  body { font-family: Arial; text-align: center; margin-top: 40px; }
  h2 { margin-bottom: 20px; }
  .controller {
    display: inline-grid;
    grid-template-columns: 80px 80px 80px;
    gap: 10px;
  }
  button {
    width: 80px; height: 80px;
    font-size: 20px;
    cursor: pointer;
  }
  #status {
    margin-top: 20px;
    text-align: left;
    display: inline-grid;
    width: 240px;
    font-size: 16px;
    color: #333;
  }
</style>
</head>
<body>
  <h2>Toy Car Controller</h2>
  <div class="controller">
    <div></div>
    <button id="up">↑</button>
    <div></div>

    <button id="left">←</button>
    <button id="down">↓</button>
    <button id="right">→</button>
    <label for="gear">Gear:</label>
    <input type="range" id="gear" name="gear" min="0" max="100" value="0" oninput= "outpu>

    <div></div>
    <label for="gear">Gear level:</label>
    <output id="output">0</output>
    <div></div>


    <div id="status">Speed: 0 | Turn: 0 </div>
  </div>
  <script>




    let speed = 0;
    let turn = 0;
    let gear = 0;

    const gearSlider = document.getElementById('gear');
    const output = document.getElementById('output');

    const updateStatus = () => {
      document.getElementById("status").innerText =
        `Speed: ${speed} | Turn: ${turn} | Gear: ${gear}`;
    };

// -----------------------------
// Send values to Flask backend
// -----------------------------
    const sendControl = async () => {
      await fetch('/control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ speed, turn, gear })
      });
    };

// -----------------------------
// Keyboard
// -----------------------------
    const handleKey = (key, isDown = true) => {
      if (!isDown) return;

      switch (key) {
        case 'ArrowUp':
          speed = Math.min(speed + 1, 100);
          break;
        case 'ArrowDown':
          speed = Math.max(speed - 1, -100);
          break;

        case ' ':
          speed = 0;
          turn = 0;
          break;
      }
      updateStatus();
      sendControl();
    };

    document.addEventListener('keydown', e => handleKey(e.key));

    // Button controls
    document.getElementById('up').onclick = () => handleKey('ArrowUp');
    document.getElementById('down').onclick = () => handleKey('ArrowDown');

// -----------------------------
// HOLD BUTTON → change steering
// RELEASE BUTTON → reset steering
// -----------------------------
    let steeringInterval = null;

    function startSteer(direction) {
  // change turn every 80 ms
      steeringInterval = setInterval(() => {
        turn += direction;         // direction = -5 (left) or +5 (right)
        turn = Math.max(Math.min(turn, 45), -45); // clamp
        updateStatus();
        sendControl();
      }, 80);
    }

    function stopSteer() {
      clearInterval(steeringInterval);
      steeringInterval = null;

  // reset steering
      turn = 0;
      updateStatus();
      sendControl();
    }
//function reset all
    function resetAll() {
      speed = 0;
      turn = 0;
      gear = 0;
      if (gearSlider) gearSlider.value = 0;
      if (output) output.value = 0;

      updateStatus();
      sendControl();   // send 0 values to backend
      console.warn("Controller disconnected — values reset");
    }
    //heartbeat
    async function heartbeat() {
      try {
        const res = await fetch("/heartbeat");
        if (res.status === 200) {
            console.log("Receive status code 200");
            return;
        }
        if (res.status === 408) {
            console.log("⚠ Server timeout — watchdog triggered");
            window.location.reload();   // <--- reload whole UI
        }
        if (!res.ok) throw new Error("Bad response");
      } catch (err) {
        resetAll();
      }
    }
    setInterval(heartbeat, 1000); //set heartbeat 1s   

// LEFT button
    const leftBtn = document.getElementById('left');
    leftBtn.addEventListener('mousedown', () => startSteer(-5));
    leftBtn.addEventListener('mouseup', stopSteer);
    leftBtn.addEventListener('mouseleave', stopSteer);

// RIGHT button
    const rightBtn = document.getElementById('right');
    rightBtn.addEventListener('mousedown', () => startSteer(5));
    rightBtn.addEventListener('mouseup', stopSteer);
    rightBtn.addEventListener('mouseleave', stopSteer);

// mobile
    leftBtn.addEventListener('touchstart', () => startSteer(-5));
    leftBtn.addEventListener('touchend', stopSteer);

    rightBtn.addEventListener('touchstart', () => startSteer(5));
    rightBtn.addEventListener('touchend', stopSteer);

// -----------------------------
// Slider
// -----------------------------
    gearSlider.addEventListener('input', () => {
      gear = parseInt(gearSlider.value, 10);
      output.value = gear;
      updateStatus();
      sendControl();
    });

  </script>
